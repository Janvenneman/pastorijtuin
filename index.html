<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>De Pastorijtuin - Reservering</title>
  <style>
    body {
      margin: 0; 
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #ccffcc; /* lichtgroen */
      text-align: center; /* alles gecentreerd */
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #f9f9f9;
      margin-top: 20px;
      border-radius: 8px;
    }
    .logo {
      max-width: 300px;
      margin-top: 20px;
    }
    .infotekst {
      font-style: italic;
      color: #666;
      margin-bottom: 20px;
    }
    .hoofdstuk {
      color: #000;
      margin: 20px 0;
      text-align: left; /* evt left-align de paragraaftekst */
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin: 20px 0;
    }
    th, td {
      border: 1px solid #000;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #ddd;
    }

    .checkbox-section {
      margin: 20px 0;
    }

    .blok-buttons {
      margin: 20px 0;
    }
    .blok-buttons button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
    }
    .blok-buttons button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }

    .tijdslot-sectie, .formulier-sectie, .final-message {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #666;
      background-color: #eee;
      display: none; /* verborgen tot we hem tonen via JS */
    }
    .tijdslot-button {
      margin: 5px;
      padding: 8px 12px;
      font-size: 1em;
      cursor: pointer;
    }
    .tijdslot-button:disabled {
      background-color: red;
      color: #fff;
      cursor: not-allowed;
    }

    .formulier-label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
      text-align: left;
    }
    .formulier-input {
      width: 80%;
      max-width: 400px;
      padding: 8px;
      margin-bottom: 10px;
    }
    .btn-verzenden {
      background-color: #000;
      color: #fff;
      padding: 10px 20px;
      border: none;
      cursor: pointer;
      font-size: 1em;
      margin-top: 10px;
    }
    .btn-verzenden:disabled {
      background-color: #999;
      cursor: not-allowed;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

  <!-- Logo bovenaan -->
  <img src="pastorijtuin_logo.jpg" alt="Pastorijtuin Logo" class="logo" />

  <div class="container">
    <!-- Infotekst (cursief) -->
    <p class="infotekst">
      Welkom op de website van de Pastorijtuin. Deze website zal enkel gebruikt worden voor de bewoners en eigenaars van onze appartementen voor bepaalde toepassingen. 
      Het heeft dus geen zin om regelmatig op deze pagina te kijken. Enkel wanneer u verwittigd wordt over een bepaalde actie/schrijven enz. kan u op deze pagina terecht.
    </p>

    <!-- Hoofdtekst -->
    <div class="hoofdstuk">
      <p>
        Beste eigenaar en bewoner,<br><br>
        De RME tracht sinds enkele jaren een groepsaankoop voor te stellen voor het onderhoud en afleveren reinigings-& verbrandingsattest.
        Ook dit jaar hebben we een voorstel bekomen bij de firma Bracq Alain. Dit voorstel hangt af van het aantal deelnemers.<br><br>
        Het voorstel bevat: Onderhoud + afleveren reinigings- & verbrandingsattest, km vergoeding (heen & terug), milieutaks, 
        en <strong>NIET</strong> inbegrepen: BTW en eventuele wisselstukken.<br><br>
        Volgende prijzen zijn bekomen voor het bijhorende deelnemers:
      </p>
    </div>

    <!-- Tabel met prijzen -->
    <table>
      <tr>
        <th>Minimum Aantal deelnemers</th>
        <th>Prijs (excl. BTW)</th>
        <th>Prijs (incl. 21% BTW)</th>
      </tr>
      <tr>
        <td>10</td>
        <td>137 &euro;</td>
        <td>165,77 &euro;</td>
      </tr>
      <tr>
        <td>15</td>
        <td>127 &euro;</td>
        <td>153,67 &euro;</td>
      </tr>
      <tr>
        <td>20</td>
        <td>117 &euro;</td>
        <td>141,57 &euro;</td>
      </tr>
      <tr>
        <td>25</td>
        <td>107 &euro;</td>
        <td>129,47 &euro;</td>
      </tr>
    </table>

    <div class="hoofdstuk">
      Indien u wenst deel te nemen, vragen wij u om <strong>eerst</strong> het vakje aan te klikken dat u akkoord bent met de prijsstelling hierboven. 
      Daarna vragen wij u te klikken op de blok waarin u woont. Dan ziet u de vastgelegde datum voor uw blok 
      en zal u 5 of 6 tijdsloten zien, welke u kan aanklikken. Vervolgens vult u uw naam en appartementblok in, 
      samen met de GSM nr of e-mailadres.
    </div>

    <!-- Checkbox -->
    <div class="checkbox-section">
      <label>
        <input type="checkbox" id="prijsCheckbox" />
        Ik heb de bovenstaande prijsstelling gelezen en begrepen.
      </label>
    </div>

    <!-- Blok-knoppen -->
    <div class="blok-buttons">
      <button id="blok3Btn" disabled>BLOK 3</button>
      <button id="blok3aBtn" disabled>BLOK 3A</button>
      <button id="blok3bBtn" disabled>BLOK 3B</button>
      <button id="blok3cBtn" disabled>BLOK 3C</button>
    </div>

    <!-- Tijdslot-sectie -->
    <div id="tijdslotSectie" class="tijdslot-sectie">
      <h3 id="datumTitel"></h3>
      <div id="tijdslotButtonsContainer"></div>
      <br>
      <button class="tijdslot-button" id="geenKeuzeBtn">
        de datum of uur-keuze passen mij niet
      </button>
    </div>

    <!-- Formulier-sectie -->
    <div id="formulierSectie" class="formulier-sectie">
      <label class="formulier-label" for="naamInput">Naam:</label>
      <input type="text" id="naamInput" class="formulier-input"
             placeholder="Vul je naam in..." required />

      <label class="formulier-label" for="adresInput">Adres appartement:</label>
      <input type="text" id="adresInput" class="formulier-input"
             placeholder="Vul je adres in..." required />

      <label class="formulier-label" for="contactInput">GSM nr of e-mailadres:</label>
      <input type="text" id="contactInput" class="formulier-input"
             placeholder="GSM of e-mail..." required />

      <label class="formulier-label" for="opmerkingenInput">Opmerkingen (optioneel):</label>
      <textarea id="opmerkingenInput" class="formulier-input"
                placeholder="Je opmerkingen..." maxlength="100"></textarea>

      <button id="verzendBtn" class="btn-verzenden" disabled>VERZENDEN</button>
    </div>

    <!-- Eindboodschap, verschijnt na verzenden -->
    <div id="finalMessage" class="final-message"></div>

  </div> <!-- einde container -->

<script>
// ----------------------------------------------------
// 1) Bepaal hier of je wel/niet FaunaDB wilt gebruiken
// ----------------------------------------------------
// - Als je wél wilt dat tijdslots centraal worden bijgehouden,
//   zet 'USE_FAUNA' op true. Dan roep je Netlify Function aan.
// - Als je geen Fauna wilt, zet 'USE_FAUNA' op false, en de
//   tijdslot-bezet-status wordt alleen lokaal bijgehouden.
const USE_FAUNA = false; // <-- Zet op true als je je Netlify Function hebt opgezet

// Dit is ons "lokale" blokData. Als USE_FAUNA = true is,
// halen we dit in principe op uit Fauna via de function (GET).
let blokData = {
  "BLOK 3": {
    date: "05/03/2025",
    timeslots: ["8.15u","9u","9.45u","10.30u","11.15u"],
    selected: [false, false, false, false, false]
  },
  "BLOK 3A": {
    date: "12/03/2025",
    timeslots: ["8.15u","9u","9.45u","10.30u","11.15u"],
    selected: [false, false, false, false, false]
  },
  "BLOK 3B": {
    date: "27/03/2025",
    timeslots: ["8.30u","9.15u","10u","10.45u","11.30u"],
    selected: [false, false, false, false, false]
  },
  "BLOK 3C": {
    date: "01/04/2025",
    timeslots: ["8.30u","9.15u","10u","10.45u","11.30u"],
    selected: [false, false, false, false, false]
  }
};

// ----------------------------------------------------
// 2) Pak referenties naar alle DOM-elementen
// ----------------------------------------------------
const prijsCheckbox = document.getElementById("prijsCheckbox");
const blok3Btn = document.getElementById("blok3Btn");
const blok3aBtn = document.getElementById("blok3aBtn");
const blok3bBtn = document.getElementById("blok3bBtn");
const blok3cBtn = document.getElementById("blok3cBtn");

const tijdslotSectie = document.getElementById("tijdslotSectie");
const datumTitel = document.getElementById("datumTitel");
const tijdslotButtonsContainer = document.getElementById("tijdslotButtonsContainer");
const geenKeuzeBtn = document.getElementById("geenKeuzeBtn");

const formulierSectie = document.getElementById("formulierSectie");
const naamInput = document.getElementById("naamInput");
const adresInput = document.getElementById("adresInput");
const contactInput = document.getElementById("contactInput");
const opmerkingenInput = document.getElementById("opmerkingenInput");
const verzendBtn = document.getElementById("verzendBtn");

const finalMessage = document.getElementById("finalMessage");

let currentBlok = null;
let currentSlotIndex = -1;

// ----------------------------------------------------
// 3) Event listeners
// ----------------------------------------------------
prijsCheckbox.addEventListener("change", () => {
  const checked = prijsCheckbox.checked;
  blok3Btn.disabled = !checked;
  blok3aBtn.disabled = !checked;
  blok3bBtn.disabled = !checked;
  blok3cBtn.disabled = !checked;
});

blok3Btn.addEventListener("click", () => showTimeslots("BLOK 3"));
blok3aBtn.addEventListener("click", () => showTimeslots("BLOK 3A"));
blok3bBtn.addEventListener("click", () => showTimeslots("BLOK 3B"));
blok3cBtn.addEventListener("click", () => showTimeslots("BLOK 3C"));

geenKeuzeBtn.addEventListener("click", () => {
  currentSlotIndex = -1; // geen slot
  showFormulier();
});

// Form-validatie
[naamInput, adresInput, contactInput].forEach(inputEl => {
  inputEl.addEventListener("input", checkFormValid);
});
opmerkingenInput.addEventListener("input", checkFormValid);

verzendBtn.addEventListener("click", (e) => {
  e.preventDefault();
  handleVerzenden();
});

// ----------------------------------------------------
// 4) Functies
// ----------------------------------------------------

// (Optioneel) Bij paginalaad de Fauna-data ophalen, als USE_FAUNA = true
window.addEventListener("DOMContentLoaded", async () => {
  if (USE_FAUNA) {
    await loadSlotsFromFauna();
  }
});

function showTimeslots(blok) {
  currentBlok = blok;
  tijdslotSectie.style.display = "block";
  formulierSectie.style.display = "none";
  finalMessage.style.display = "none";

  datumTitel.textContent = `Datum voor ${blok}: ${blokData[blok].date}`;
  tijdslotButtonsContainer.innerHTML = "";

  blokData[blok].timeslots.forEach((slot, index) => {
    const btn = document.createElement("button");
    btn.textContent = slot;
    btn.classList.add("tijdslot-button");

    if (blokData[blok].selected[index]) {
      // Al bezet
      btn.disabled = true;
      btn.style.backgroundColor = "red";
      btn.style.color = "#fff";
    } else {
      btn.addEventListener("click", () => {
        currentSlotIndex = index;
        showFormulier();
      });
    }
    tijdslotButtonsContainer.appendChild(btn);
  });
}

function showFormulier() {
  tijdslotSectie.style.display = "none";
  formulierSectie.style.display = "block";
  finalMessage.style.display = "none";

  // evt. adresInput.value = currentBlok (als je dat wilt)
  checkFormValid();
}

function checkFormValid() {
  // Minimale validatie: alle required velden niet leeg
  let allRequiredFilled = naamInput.value.trim() && adresInput.value.trim() && contactInput.value.trim();
  verzendBtn.disabled = !allRequiredFilled;
}

// Als de gebruiker klikt op VERZENDEN
async function handleVerzenden() {
  const naamVal = capitalizeFirst(naamInput.value.trim());
  const adresVal = adresInput.value.trim();
  const contactVal = contactInput.value.trim();
  const opmerkingenVal = opmerkingenInput.value.trim();

  let chosenSlotText = "";
  if (currentSlotIndex === -1) {
    // "Geen datum/uur"
    chosenSlotText = "GEEN datum/uur (past niet)";
  } else {
    chosenSlotText = blokData[currentBlok].timeslots[currentSlotIndex];
  }

  // 1) Verstuur data naar Formspree
  // --------------------------------
  try {
    await fetch("https://formspree.io/f/mkgondal", {
      method: "POST",
      headers: {
        "Accept": "application/json",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        blok: currentBlok,
        tijdslot: chosenSlotText,
        naam: naamVal,
        adres: adresVal,
        contact: contactVal,
        opmerkingen: opmerkingenVal
      })
    });
    // We gaan er vanuit dat dit gelukt is. (Errorhandling kan uitgebreider.)
  } catch (err) {
    alert("Fout bij versturen via Formspree: " + err);
  }

  // 2) Markeer in Fauna dat slot bezet is (indien we wel een slot kozen)
  // -------------------------------------------------------------------
  if (USE_FAUNA && currentSlotIndex !== -1) {
    await markSlotInFauna(currentBlok, currentSlotIndex);
  }

  // 3) Update UI (slot lokaal bezet)
  // --------------------------------
  if (currentSlotIndex !== -1) {
    blokData[currentBlok].selected[currentSlotIndex] = true;
    // Toon "Gelukt" melding
    showFinalMessage(true, currentBlok, blokData[currentBlok].date, chosenSlotText);
  } else {
    // Geen slot gekozen => andere melding
    showFinalMessage(false);
  }

  // 4) Reset velden
  naamInput.value = "";
  adresInput.value = "";
  contactInput.value = "";
  opmerkingenInput.value = "";
  currentBlok = null;
  currentSlotIndex = -1;
  verzendBtn.disabled = true;
}

function showFinalMessage(chosenSlot, blok = "", datum = "", uur = "") {
  // Verberg formulieren
  tijdslotSectie.style.display = "none";
  formulierSectie.style.display = "none";
  finalMessage.style.display = "block";

  if (chosenSlot) {
    // Gebruiker koos een slot
    finalMessage.innerHTML = `
      <h2>GELUKT!</h2>
      <p>U koos voor <strong>${blok}</strong> op <strong>${datum}</strong> om <strong>${uur}</strong>.</p>
      <p>Wij bevestigen via de Whatsapp-groep zo snel mogelijk
         het aantal deelnemers en de corresponderende prijs.</p>
    `;
  } else {
    // Gebruiker klikte “de datum/uur passen mij niet”
    finalMessage.innerHTML = `
      <h2>Geen geschikte datum/uur</h2>
      <p>
        Beste bewoner/eigenaar, wij begrijpen dat een gereserveerde datum
        en/of uurslot niet altijd past. Wij zullen zo snel mogelijk
        kijken of er op andere data een alternatief mogelijk is.
        Wij contacteren u zo snel mogelijk.
      </p>
    `;
  }
}

// Hulp: eerste letter hoofdletter maken
function capitalizeFirst(str) {
  if (!str) return "";
  return str.charAt(0).toUpperCase() + str.slice(1);
}

// ----------------------------------------------------
// 5) Fauna functions (OPTIONEEL)
// ----------------------------------------------------
async function loadSlotsFromFauna() {
  // Haal data op uit de Netlify Function
  try {
    const response = await fetch("/.netlify/functions/reserve?mode=get");
    if (!response.ok) {
      console.error("Fout bij ophalen Fauna-gegevens:", response.status);
      return;
    }
    const data = await response.json();
    // data heeft de structuur van blokData
    blokData = data;
    console.log("Succesvol opgehaald uit Fauna:", blokData);
  } catch (err) {
    console.error("Error fetch fauna:", err);
  }
}

async function markSlotInFauna(blok, index) {
  try {
    const response = await fetch("/.netlify/functions/reserve", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ blok, index })
    });
    if (!response.ok) {
      console.error("Fout bij opslaan Fauna:", response.status);
    } else {
      const updatedData = await response.json();
      blokData = updatedData; // update local data
      console.log("Slot gemarkeerd in Fauna", blokData);
    }
  } catch (err) {
    console.error("Fout bij POST naar Fauna function:", err);
  }
}
</script>
</body>
</html>
