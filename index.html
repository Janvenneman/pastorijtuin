<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>De Pastorijtuin - Reservering</title>
  <style>
    /* Algemeen opmaak */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #ccffcc; /* lichtgroen */
      text-align: center;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Logo groter */
    .logo {
      margin-top: 20px;
      max-width: 500px; /* groter logo */
      width: 100%;
      height: auto;
    }

    /* Tekst onder logo: vet grijs, ander lettertype */
    .infotekst {
      font-family: Georgia, serif; /* wat stijlvoller */
      font-weight: bold;          /* vetgedrukt */
      color: #555;               /* grijs */
      margin-bottom: 20px;
      margin-top: 10px;
      font-size: 1.1em;
      /* achtergrond weglaten: geen white background */
    }

    .hoofdstuk {
      color: #000;
      margin: 20px 0;
      text-align: left;
      line-height: 1.5;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin: 20px 0;
    }
    th, td {
      border: 1px solid #000;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #ddd;
    }

    .checkbox-section {
      margin: 20px 0;
    }

    /* Blok-buttons */
    .blok-buttons {
      margin: 20px 0;
    }
    .blok-buttons button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
    }
    .blok-buttons button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }

    .tijdslot-sectie, .formulier-sectie, .final-message {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #666;
      background-color: #eee;
      display: none; /* verborgen tot we ze tonen via JS */
      text-align: center; /* centreren inhoud */
    }

    /* Tijdslot-knoppen met kleuren (groen/rood/oranje) */
    .tijdslot-button {
      margin: 5px;
      padding: 8px 12px;
      font-size: 1em;
      cursor: pointer;
      color: #fff; /* standaard wit, dan overschrijven we via background-color */
    }
    /* vrij = groen */
    .tijdslot-button.free {
      background-color: green;
    }
    /* bezet = rood */
    .tijdslot-button.busy {
      background-color: red;
    }
    /* de datum/uur past niet = oranje */
    #geenKeuzeBtn {
      background-color: orange;
      color: #fff;
    }

    .formulier-label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
      text-align: left;
    }
    .formulier-input {
      width: 80%;
      max-width: 400px;
      padding: 8px;
      margin-bottom: 10px;
    }
    /* Opmerkingen veld gecentreerd: we doen dit door de container centreren? 
       We kunnen in-line style doen, of nog een wrapper. */
    #opmerkingenInput {
      display: block;
      margin: 0 auto 10px auto;
      width: 80%;
      max-width: 400px;
      min-height: 60px;
    }

    /* De knop verzenden links van de invoervelden:
       We kunnen hem 'float' of met absolute positioning. 
       Simpele manier: we geven hem "display:inline-block" en wat margin. 
       But to keep it simpler, let's do a small .button-container to the left. */
    .form-grid {
      display: flex;
      justify-content: center; /* centreren het geheel horizontaal */
      align-items: flex-start; /* bovenaan uitlijnen */
      gap: 30px; /* ruimte tussen button en de inputs */
      flex-wrap: wrap; /* als scherm smal is, wraps */
    }

    .form-left {
      /* hier zetten we de verzendknop */
    }
    .form-right {
      /* hier de inputs */
      display: flex;
      flex-direction: column; /* verticale stapeling */
      align-items: center;    /* center inputs horizontally */
    }

    .btn-verzenden {
      background-color: #000;
      color: #fff;
      padding: 10px 20px;
      border: none;
      cursor: pointer;
      font-size: 1em;
      margin-top: 10px;
      display: inline-block;
    }
    .btn-verzenden:disabled {
      background-color: #999;
      cursor: not-allowed;
    }

    .final-message {
      margin-top: 30px;
    }
  </style>
</head>
<body>

  <!-- Logo bovenaan -->
  <img src="pastorijtuin_logo.jpg" alt="Pastorijtuin Logo" class="logo" />

  <div class="container">
    <p class="infotekst">
      Welkom op de website van de Pastorijtuin. Deze website zal enkel gebruikt worden voor
      de bewoners en eigenaars van onze appartementen voor bepaalde toepassingen.
      Het heeft dus geen zin om regelmatig op deze pagina te kijken. Enkel wanneer u verwittigd
      wordt over een bepaalde actie/schrijven enz. kan u op deze pagina terecht.
    </p>

    <!-- Hoofdtekst -->
    <div class="hoofdstuk">
      <p>
        <strong>De RME tracht sinds enkele jaren een interessante groepsaankoop</strong> voor het 
        onderhoud verwarmingsinstallatie en afleveren reinigings-& verbrandingsattest. 
        <br><br>
        Dit jaar hebben we dit terug bekomen bij <strong>Bracq Alain</strong>, na vergelijkingen op de markt.
      </p>
    </div>

    <!-- Tabel met prijzen -->
    <table>
      <tr>
        <th>Minimum Aantal deelnemers</th>
        <th>Prijs (excl. BTW)</th>
        <th>Prijs (incl. 21% BTW)</th>
      </tr>
      <tr>
        <td>10</td>
        <td>137 &euro;</td>
        <td>165,77 &euro;</td>
      </tr>
      <tr>
        <td>15</td>
        <td>127 &euro;</td>
        <td>153,67 &euro;</td>
      </tr>
      <tr>
        <td>20</td>
        <td>117 &euro;</td>
        <td>141,57 &euro;</td>
      </tr>
      <tr>
        <td>25</td>
        <td>107 &euro;</td>
        <td>129,47 &euro;</td>
      </tr>
    </table>

    <div class="hoofdstuk">
      Indien u wenst deel te nemen, vragen wij u om <strong>eerst</strong> het vakje aan te klikken dat u akkoord bent
      met de prijsstelling hierboven. Daarna vragen wij u te klikken op de blok waarin u woont. Dan ziet u de vastgelegde datum 
      voor uw blok en zal u 5 of 6 tijdsloten zien, welke u kan aanklikken. Vervolgens vult u uw naam en appartementblok in, 
      samen met de GSM nr of e-mailadres.
    </div>

    <!-- Checkbox -->
    <div class="checkbox-section">
      <label>
        <input type="checkbox" id="prijsCheckbox" />
        Ik heb de bovenstaande prijsstelling gelezen en begrepen.
      </label>
    </div>

    <!-- Blok-knoppen -->
    <div class="blok-buttons">
      <button id="blok3Btn" disabled>BLOK 3</button>
      <button id="blok3aBtn" disabled>BLOK 3A</button>
      <button id="blok3bBtn" disabled>BLOK 3B</button>
      <button id="blok3cBtn" disabled>BLOK 3C</button>
    </div>

    <!-- Tijdslot-sectie -->
    <div id="tijdslotSectie" class="tijdslot-sectie">
      <h3 id="datumTitel"></h3>
      <div id="tijdslotButtonsContainer"></div>
      <br>
      <button class="tijdslot-button" id="geenKeuzeBtn">
        de datum en uur passen mij niet
      </button>
    </div>

    <!-- Formulier-sectie -->
    <div id="formulierSectie" class="formulier-sectie">

      <div class="form-grid">
        <!-- Linkerkolom: de VERZENDEN knop -->
        <div class="form-left">
          <button id="verzendBtn" class="btn-verzenden" disabled>VERZENDEN</button>
        </div>
        <!-- Rechterkolom: de inputvelden -->
        <div class="form-right">
          <label class="formulier-label" for="naamInput">Naam:</label>
          <input
            type="text"
            id="naamInput"
            class="formulier-input"
            placeholder="Vul je naam in..."
            required
          />

          <label class="formulier-label" for="adresInput">Adres appartement (verder aanvullen):</label>
          <input
            type="text"
            id="adresInput"
            class="formulier-input"
            placeholder=""
            required
          />

          <label class="formulier-label" for="contactInput">GSM nr of e-mailadres:</label>
          <input
            type="text"
            id="contactInput"
            class="formulier-input"
            placeholder="GSM of e-mail..."
            required
          />

          <label class="formulier-label" for="opmerkingenInput">Opmerkingen (optioneel):</label>
          <textarea
            id="opmerkingenInput"
            class="formulier-input"
            placeholder="Je opmerkingen (max 100 tekens)"
            maxlength="100"
          ></textarea>
        </div>
      </div>

    </div>

    <!-- Eindboodschap, verschijnt na verzenden -->
    <div id="finalMessage" class="final-message"></div>
  </div> <!-- einde container -->

<script>
/* 
   COMPLEET SCRIPT (frontend logic) 
   Inclusief 409-check bij POST.

   Let op:
   - Als je ECHT Fauna + Netlify wilt gebruiken, zet USE_FAUNA op true.
   - Dan moet er een serverless function zijn op '/.netlify/functions/reserve'
     die op double booking een 409 teruggeeft.
   - Anders laat je USE_FAUNA = false en er is geen concurrency-check.
*/

const USE_FAUNA = true; // zet true als je Netlify Function + Fauna hebt

// 1) BlokData (lokaal). Wordt overschreven door GET van Fauna als USE_FAUNA=true
let blokData = {
  "BLOK 3": {
    date: "05/03/2025",
    timeslots: ["8.15u","9u","9.45u","10.30u","11.15u"],
    selected: [false, false, false, false, false]
  },
  "BLOK 3A": {
    date: "12/03/2025",
    timeslots: ["8.15u","9u","9.45u","10.30u","11.15u"],
    selected: [false, false, false, false, false]
  },
  "BLOK 3B": {
    date: "27/03/2025",
    timeslots: ["8.30u","9.15u","10u","10.45u","11.30u"],
    selected: [false, false, false, false, false]
  },
  "BLOK 3C": {
    date: "01/04/2025",
    timeslots: ["8.30u","9.15u","10u","10.45u","11.30u"],
    selected: [false, false, false, false, false]
  }
};

// 2) Pak DOM-elementen
const prijsCheckbox = document.getElementById("prijsCheckbox");
const blok3Btn = document.getElementById("blok3Btn");
const blok3aBtn = document.getElementById("blok3aBtn");
const blok3bBtn = document.getElementById("blok3bBtn");
const blok3cBtn = document.getElementById("blok3cBtn");

const tijdslotSectie = document.getElementById("tijdslotSectie");
const datumTitel = document.getElementById("datumTitel");
const tijdslotButtonsContainer = document.getElementById("tijdslotButtonsContainer");
const geenKeuzeBtn = document.getElementById("geenKeuzeBtn");

const formulierSectie = document.getElementById("formulierSectie");
const naamInput = document.getElementById("naamInput");
const adresInput = document.getElementById("adresInput");
const contactInput = document.getElementById("contactInput");
const opmerkingenInput = document.getElementById("opmerkingenInput");
const verzendBtn = document.getElementById("verzendBtn");
const finalMessage = document.getElementById("finalMessage");

let currentBlok = null;
let currentSlotIndex = -1;

// 3) Event Listeners
prijsCheckbox.addEventListener("change", () => {
  const checked = prijsCheckbox.checked;
  blok3Btn.disabled = !checked;
  blok3aBtn.disabled = !checked;
  blok3bBtn.disabled = !checked;
  blok3cBtn.disabled = !checked;
});

blok3Btn.addEventListener("click", () => showTimeslots("BLOK 3"));
blok3aBtn.addEventListener("click", () => showTimeslots("BLOK 3A"));
blok3bBtn.addEventListener("click", () => showTimeslots("BLOK 3B"));
blok3cBtn.addEventListener("click", () => showTimeslots("BLOK 3C"));

geenKeuzeBtn.addEventListener("click", () => {
  currentSlotIndex = -1;
  showFormulier();
});

// Validatie
[naamInput, adresInput, contactInput, opmerkingenInput].forEach(el => {
  el.addEventListener("input", checkFormValid);
});

// Verzenden
verzendBtn.addEventListener("click", (e) => {
  e.preventDefault();
  handleVerzenden();
});

// Bij paginalaad: eventueel direct fauna-data ophalen
window.addEventListener("DOMContentLoaded", async () => {
  if (USE_FAUNA) {
    await loadSlotsFromFauna();
  }
});

// 4) Functies

function showTimeslots(blok) {
  currentBlok = blok;
  tijdslotSectie.style.display = "block";
  formulierSectie.style.display = "none";
  finalMessage.style.display = "none";

  datumTitel.textContent = `Datum voor ${blok}: ${blokData[blok].date}`;
  tijdslotButtonsContainer.innerHTML = "";

  blokData[blok].timeslots.forEach((slot, index) => {
    const btn = document.createElement("button");
    btn.textContent = slot;
    btn.classList.add("tijdslot-button");

    if (blokData[blok].selected[index]) {
      // bezet
      btn.classList.add("busy");
      btn.disabled = true;
    } else {
      // vrij
      btn.classList.add("free");
      btn.disabled = false;
      btn.addEventListener("click", () => {
        currentSlotIndex = index;
        showFormulier();
      });
    }
    tijdslotButtonsContainer.appendChild(btn);
  });
}

function showFormulier() {
  tijdslotSectie.style.display = "none";
  formulierSectie.style.display = "block";
  finalMessage.style.display = "none";

  // Vul 'Adres appartement' al in met het gekozen blok (verder aanvullen)
  if (currentSlotIndex !== -1) {
    // bv. "BLOK 3 "
    adresInput.value = currentBlok + " ";
  } else {
    adresInput.value = "";
  }

  checkFormValid();
}

function checkFormValid() {
  let allRequiredFilled = naamInput.value.trim() && adresInput.value.trim() && contactInput.value.trim();
  verzendBtn.disabled = !allRequiredFilled;
}

async function handleVerzenden() {
  const naamVal = capitalizeFirst(naamInput.value.trim());
  const adresVal = adresInput.value.trim();
  const contactVal = contactInput.value.trim();
  const opmerkingenVal = opmerkingenInput.value.trim();

  let chosenSlotText = "";
  if (currentSlotIndex === -1) {
    chosenSlotText = "GEEN datum/uur (past niet)";
  } else {
    chosenSlotText = blokData[currentBlok].timeslots[currentSlotIndex];
  }

  // 1) Stuur data naar Formspree (of eender welke mailservice)
  try {
    await fetch("https://formspree.io/f/mkgondal", {
      method: "POST",
      headers: { "Accept": "application/json", "Content-Type": "application/json" },
      body: JSON.stringify({
        blok: currentBlok,
        tijdslot: chosenSlotText,
        naam: naamVal,
        adres: adresVal,
        contact: contactVal,
        opmerkingen: opmerkingenVal
      })
    });
  } catch (err) {
    alert("Fout bij versturen mail: " + err);
  }

  // 2) Markeer slot in Fauna (als er een slot is gekozen en we Fauna gebruiken)
  if (USE_FAUNA && currentSlotIndex !== -1) {
    try {
      const response = await fetch("/.netlify/functions/reserve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ blok: currentBlok, index: currentSlotIndex })
      });

      if (response.status === 409) {
        // Conflict => slot was net ingenomen door iemand anders
        alert("Dit tijdslot is helaas net door iemand anders geboekt. Kies een ander slot!");
        await loadSlotsFromFauna(); // UI verversen
        return;
      }

      if (!response.ok) {
        throw new Error("Serverfout: " + response.status);
      }

      const updatedData = await response.json();
      blokData = updatedData;
    } catch (err) {
      alert("Fout bij Fauna reservering: " + err);
    }
  }

  // 3) Toon eindboodschap
  if (currentSlotIndex !== -1) {
    // Gekozen slot
    showFinalMessage(true, currentBlok, blokData[currentBlok].date, chosenSlotText);
  } else {
    // Geen slot
    showFinalMessage(false);
  }

  // 4) Reset fields
  naamInput.value = "";
  adresInput.value = "";
  contactInput.value = "";
  opmerkingenInput.value = "";
  currentBlok = null;
  currentSlotIndex = -1;
  verzendBtn.disabled = true;
}

function showFinalMessage(chosenSlot, blok = "", datum = "", uur = "") {
  tijdslotSectie.style.display = "none";
  formulierSectie.style.display = "none";
  finalMessage.style.display = "block";

  if (chosenSlot) {
    finalMessage.innerHTML = `
      <h2>GELUKT!</h2>
      <p>U koos voor <strong>${blok}</strong> op <strong>${datum}</strong> om <strong>${uur}</strong>.</p>
      <p>Wij bevestigen via de Whatsapp-groep zo snel mogelijk
         het aantal deelnemers en de corresponderende prijs.</p>
    `;
  } else {
    finalMessage.innerHTML = `
      <h2>Geen geschikte datum/uur</h2>
      <p>
        Beste bewoner/eigenaar, wij begrijpen dat een gereserveerde datum
        en/of uurslot niet altijd past. Wij zullen zo snel mogelijk
        kijken of er op andere data een alternatief mogelijk is.
        Wij contacteren u zo snel mogelijk.
      </p>
    `;
  }
}

function capitalizeFirst(str) {
  if (!str) return "";
  return str.charAt(0).toUpperCase() + str.slice(1);
}

/* Fauna GET: haal de meest recente selected[] data op */
async function loadSlotsFromFauna() {
  try {
    const response = await fetch("/.netlify/functions/reserve?mode=get");
    if (!response.ok) {
      console.error("Fout bij ophalen Fauna-gegevens:", response.status);
      return;
    }
    const data = await response.json();
    blokData = data;
    console.log("Blokdata uit Fauna:", blokData);
  } catch (err) {
    console.error("Error fetch fauna:", err);
  }
}
</script>
</body>
</html>
